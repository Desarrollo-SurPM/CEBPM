{% extends 'admin/base_admin.html' %}

{% block title %}Comunicaciones{% endblock %}
{% block content %}
<h1 class="h3 mb-4 text-gray-800">Comunicaciones y Notificaciones</h1>

<div class="row">
    <div class="col-lg-7">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-send-fill me-2"></i>Enviar Nueva Notificación
                </h6>
            </div>
            <div class="card-body">
                <form method="POST" action="{% url 'admin_panel:send_notification' %}" enctype="multipart/form-data">
                {% csrf_token %}
                    <div class="mb-3">
                        <label for="title" class="form-label">Asunto (Título):</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="recipient_type" class="form-label">Enviar a:</label>
                        <select class="form-select" id="recipient_type" name="recipient_type" required>
                            <option value="all_guardians">Todos los Apoderados</option>
                            <option value="multiple_categories">Una o Múltiples Categorías...</option>
                            <option value="specific_email">Un Apoderado Específico (por Email)</option>
                            <option value="all_admins">Todos los Administradores</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="category-selector" style="display: none;">
                        <label for="category" class="form-label">Seleccionar Categorías:</label>
                        <select class="form-select" id="category" name="category" multiple size="5">
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Mantén presionada la tecla Ctrl (o Cmd en Mac) para seleccionar más de una.</small>
                    </div>

                    <div class="mb-3" id="specific-email-selector" style="display: none;">
                        <label for="specific_email" class="form-label">Email del Apoderado:</label>
                        <input type="email" class="form-control" id="specific_email" name="specific_email" placeholder="apoderado@ejemplo.com">
                    </div>

                    <div class="mb-3">
                        <label for="message" class="form-label">Mensaje:</label>
                        <textarea class="form-control" id="message" name="message" rows="8" required placeholder="Escribe tu mensaje aquí. Se enviará al panel."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="attachment" class="form-label">Adjuntar Archivo (Opcional):</label>
                        <input class="form-control" type="file" id="attachment" name="attachment">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send me-2"></i>Enviar Mensaje
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-5">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-clock-history me-2"></i>Historial de Mensajes Enviados
                </h6>
            </div>
            <div class="card-body">
                {% if messages_list %}
                    <div class="list-group list-group-flush">
                        {% for message in messages_list %}
                            <a href="{% url 'admin_panel:communication_status' message.pk %}" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ message.title }}</h6>
                                    <small>{{ message.sent_at|timesince }}</small>
                                </div>
                                <small class="text-muted">Enviado por {{ message.created_by.username }}</small>
                            </a>
                            {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No se han enviado mensajes.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // JS para mostrar/ocultar los selectores
    document.getElementById('recipient_type').addEventListener('change', function() {
        var categorySelector = document.getElementById('category-selector');
        var emailSelector = document.getElementById('specific-email-selector');
        
        if (this.value === 'multiple_categories') {
            categorySelector.style.display = 'block';
            emailSelector.style.display = 'none';
        } else if (this.value === 'specific_email') {
            categorySelector.style.display = 'none';
            emailSelector.style.display = 'block';
        } else {
            categorySelector.style.display = 'none';
            emailSelector.style.display = 'none';
        }
    });
</script>
{% endblock %}